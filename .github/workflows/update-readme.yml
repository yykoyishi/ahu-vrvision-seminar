name: è‡ªåŠ¨æ›´æ–°READMEå’Œéƒ¨ç½²ç½‘ç«™

on:
  push:
    paths:
      - '_posts/**'
      - '_layouts/**'
      - '_config.yml'
      - 'assets/**'
      - '*.md'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3

      - name: è®¾ç½®Rubyç¯å¢ƒ
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.0'
          bundler-cache: true

      - name: å®‰è£…ä¾èµ–
        run: gem install jekyll jekyll-feed jekyll-paginate

      - name: ç”Ÿæˆè®ºæ–‡åˆ—è¡¨
        run: |
          cat > README.md << EOF
          # ğŸ“š ç»„å†…è®ºæ–‡åˆ†äº«
          ## ğŸ“– AHU VR&Vision Seminars

          åœ¨è¿™é‡Œè®°å½•æˆ‘ä»¬ç»„å†…çš„è®ºæ–‡åˆ†äº«å’Œè®¨è®ºã€‚æ¯å‘¨æ›´æ–°ã€‚

          ### ğŸŒŸ 2025å¹´æ˜¥å­£å­¦æœŸ

          | æ—¥æœŸ | æ±‡æŠ¥äºº | è®ºæ–‡ |
          | :---: |:---:|:---:|
          EOF
          
          # ä»_postsç›®å½•è¯»å–è®ºæ–‡ä¿¡æ¯å¹¶æ·»åŠ åˆ°README
          for file in _posts/*.md; do
            if [ -f "$file" ]; then
              date=$(grep -m 1 "date:" "$file" | sed 's/date: //')
              presenter=$(grep -m 1 "presenter:" "$file" | sed 's/presenter: //' | sed 's/"//g')
              title=$(grep -m 1 "title:" "$file" | sed 's/title: //' | sed 's/"//g')
              journal=$(grep -m 1 "journal:" "$file" | sed 's/journal: //' | sed 's/"//g')
          
              # è·å–æ–‡ä»¶åï¼ˆä¸å«è·¯å¾„å’Œæ‰©å±•åï¼‰
              filename=$(basename "$file" .md)
          
              # æ„å»ºGitHub Pagesé“¾æ¥
              gh_pages_link="https://linbowang.github.io/ahu-vrvision-seminar/papers/${filename#*-*-*-}"
          
              # æ ¼å¼åŒ–æ—¥æœŸ
              formatted_date=$(date -d "$date" +"%Y.%m.%d" 2>/dev/null || echo "$date")
          
              # æ·»åŠ åˆ°README
              echo "| $formatted_date | $presenter | [$title]($gh_pages_link) ($journal) |" >> README.md
            fi
          done
          
          # æ·»åŠ åˆ†äº«è§„åˆ™
          cat >> README.md << EOF


          ### ğŸ“‹ åˆ†äº«è§„åˆ™
          1. â° æ¯å‘¨ä¸‰ä¸Šåˆ8:30-11:30è¿›è¡Œç»„ä¼šæŠ¥å‘Š
          2. ğŸ“Š æ¯äººæ¯æ¬¡åˆ†äº«1ç¯‡è®ºæ–‡ï¼Œæ§åˆ¶æ—¶é—´åœ¨20-30åˆ†é’Ÿ
          3. ğŸ“ åˆ†äº«å†…å®¹åŒ…æ‹¬ä½†ä¸é™äºï¼š
             - ğŸ” è®ºæ–‡çš„æ ¸å¿ƒåˆ›æ–°ç‚¹
             - ğŸ› ï¸ æ–¹æ³•çš„æŠ€æœ¯ç»†èŠ‚
             - ğŸ“ˆ å®éªŒç»“æœåˆ†æ
             - ğŸ’¡ ä¸ªäººè§è§£ä¸æ€è€ƒ
          4. ğŸ¤ é¼“åŠ±ç§¯æè®¨è®ºï¼Œæå‡ºé—®é¢˜å’Œå»ºè®®
          ---

          > ğŸ’« æ¬¢è¿å¤§å®¶ç§¯æå‚ä¸ç»„ä¼šè®¨è®ºï¼å¦‚æœ‰ä»»ä½•å»ºè®®ï¼Œè¯·éšæ—¶æå‡ºã€‚
          EOF

      - name: æäº¤æ›´æ–°çš„README
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          git commit -m "è‡ªåŠ¨æ›´æ–°è®ºæ–‡åˆ—è¡¨ [skip ci]" || echo "æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: æ„å»ºç½‘ç«™
        run: jekyll build

      - name: éƒ¨ç½²åˆ° GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: "_site/"

      - name: å‘å¸ƒç½‘ç«™
        uses: actions/deploy-pages@v4
